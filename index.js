"use strict";exports.__esModule=!0;var express=require("express"),pino=require("pino"),moment=require("moment"),momentz=require("moment-timezone"),cookieParser=require("cookie-parser"),body_parser_1=require("body-parser"),helmet=require("helmet"),timeZone=process.env.timeZone?process.env.timeZone:"Asia/Kolkata",now=function(){return moment().format()},normallocalvalue=function(){return momentz(now()).tz(timeZone).format()},app=express(),genericHandlers=function(){function e(e,r,t,o,n){var a=this;this.generate=function(e){return e},this.errorInfo=function(e,r,t){var o={timestamp:normallocalvalue(),errorMessage:e,errorOrigin:r,errorLevel:t};return pino().error(o),o},this.info=function(e,r,t){var o={timestamp:normallocalvalue(),message:e,origin:r,level:t};return pino().info(o),o},this.globalErrorHandler=function(e,r,t,o){if(a.errorInfo("Application Error Handler called : "+e,"globalErrorHandler",10),e){var n=a.errResponse?a.errResponse:a.generate({error:!0,message:"Some error occured at global level",status:500,data:null});t.status(500).send(n)}},this.globalNotFoundHandler=function(e,r,t){a.errorInfo("Global not found handler called","globalNotFoundHandler",10);var o=a.notFoundResponse?a.notFoundResponse:a.generate({error:!0,message:"Route not found in the application",status:404,data:null});r.status(404).send(o)},this.generate=e||this.generate,this.errorInfo=r||this.errorInfo,this.info=t||this.info,this.globalErrorHandler=o||this.globalErrorHandler,this.globalNotFoundHandler=n||this.globalNotFoundHandler}return e.prototype.responseGenerator=function(e,r,t){this.generate=e,this.notFoundResponse=r,this.errResponse=t},e.prototype.errorInfoGenerator=function(e){this.errorInfo=e},e.prototype.infoGenerator=function(e){this.info=e},e.prototype.globalErrorHandlerGenerator=function(e){this.globalErrorHandler=e},e.prototype.globalNotFoundHandlerrGenerator=function(e){this.globalNotFoundHandler=e},e}();exports.genericHandlers=genericHandlers;var initiateExpress=function(){function e(e){var r,t,o,n,a;this.app=express(),this.allowedCorsOrigin="*",this.allowedMethods="*",this.allowedHeaders="*",this.allowedCred=!1,this.allowedMaxAge="86400",this.AppUtility=new genericHandlers,this.normalHeaders=[["Access-Control-Allow-Origin",""+this.allowedCorsOrigin],["Access-Control-Allow-Methods",""+this.allowedMethods],["Access-Control-Allow-Headers",""+this.allowedHeaders],["Access-Control-Allow-Credentials",this.allowedCred],["Access-Control-Max-Age",this.allowedMaxAge]],this.routes=e.routes,this.initialHandlers=e.initialHandlers?[body_parser_1.json(),body_parser_1.urlencoded({extended:!1}),cookieParser()].concat(e.initialHandlers):[body_parser_1.json(),body_parser_1.urlencoded({extended:!1}),cookieParser(),helmet()],this.finalhandlers=e.finalhandlers?e.finalhandlers:[],this.CommonUtilizedHandler=[e.defaultErrHandler?e.defaultErrHandler:this.AppUtility.globalErrorHandler,e.notFoundHandler?e.notFoundHandler:this.AppUtility.globalNotFoundHandler],this.normalHeaders=e.newAllHeaders?this.normalHeaders.concat(e.newAllHeaders):this.normalHeaders,this.allowedCorsOrigin=(null===(r=e.OptionObjet)||void 0===r?void 0:r.allowedCorsOrigin)?e.OptionObjet.allowedCorsOrigin:"*",this.allowedMethods=(null===(t=e.OptionObjet)||void 0===t?void 0:t.allowedMethods)?e.OptionObjet.allowedMethods.toString():"*",this.allowedHeaders=(null===(o=e.OptionObjet)||void 0===o?void 0:o.allowedHeaders)?e.OptionObjet.allowedHeaders.toString():"*",this.allowedCred=!(null===(n=e.OptionObjet)||void 0===n||!n.allowedCred)&&e.OptionObjet.allowedCred,this.allowedMaxAge=!(null===(a=e.OptionObjet)||void 0===a?void 0:a.allowedMaxAge)||isNaN(Number(e.OptionObjet.allowedMaxAge))?"86400":e.OptionObjet.allowedMaxAge}return e.prototype.RouteHandler=function(e,r){try{if(0===r.length)throw"routemismatch";for(var t=0,o=r;t<o.length;t++){var n=o[t];if("OPTIONS"===n.type.toUpperCase())return void e.use(n.middleware);n.middleware&&Array.isArray(n.middleware)?e[n.type.toLowerCase()](n.path,n.middleware,n.requesthandler):e[n.type.toLowerCase()](n.path,n.requesthandler)}}catch(e){throw e}},e.prototype.resHeaderSet=function(e,r){try{e.all("*",function(e,t,o){try{for(var n=0,a=r;n<a.length;n++){var i=a[n];t.header(i[0],i[1])}if("OPTIONS"===e.method)return void t.status(200).end();o()}catch(e){o(e)}})}catch(e){throw e}},e.prototype.setParicularHeaders=function(e,r){try{r.some(function(e){return!!e.distinctHeaders})&&r.forEach(function(r){r.distinctHeaders&&Array.isArray(r.distinctHeaders)&&r.distinctHeaders.every(function(e){return Array.isArray(e)})&&e.all(r.path,function(e,t,o){try{for(var n=0,a=r.distinctHeaders;n<a.length;n++){var i=a[n];t.header(i[0],i[1])}o()}catch(e){o(e)}})})}catch(e){throw e}},e.prototype.initiateAppEngine=function(){try{this.app.use(this.initialHandlers),this.resHeaderSet(this.app,this.normalHeaders),this.setParicularHeaders(this.app,this.routes),this.RouteHandler(this.app,this.routes),this.app.use(this.finalhandlers.concat(this.CommonUtilizedHandler))}catch(e){this.app.use(this.AppUtility.globalErrorHandler)}},e}();exports.initiateExpress=initiateExpress,exports.default=initiateExpress;